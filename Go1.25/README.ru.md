# Backend-разработка на Go 1.25

## 📋 Содержание

- [Цель проекта](#цель-проекта)
- [Ключевые функции](#ключевые-функции)
- [Технологический стек](#технологический-стек)
- [Архитектура проекта](#архитектура-проекта)
- [Структура проекта](#структура-проекта)
- [База данных](#база-данных)
- [Установка и запуск](#установка-и-запуск)
- [Конфигурация](#конфигурация)
- [Этапы разработки](#этапы-разработки)

## 🎯 Цель проекта

Создание высокопроизводительного и масштабируемого серверного приложения для обработки всей игровой логики, взаимодействия с базой данных и предоставления API для клиентской части игры "Выбери меня".

## 🚀 Ключевые функции

- **API для клиента:** Предоставление RESTful API для всех клиентских запросов (регистрация, получение данных мира, действия игрока)
- **Управление пользователями:** Логика регистрации, авторизации, управления сессиями с поддержкой множественных устройств
- **Система кланов:** Полноценная система кланов с ролями и кастомными названиями
- **Игровая логика:**
  - Генерация и управление состоянием игрового мира
  - Процедурная генерация персонажей (на основе JSON-тегов)
  - Обработка игровых событий и действий игрока
  - Расчет механик упадка, прокачки, взаимодействия NPC
- **Интеграция с n8n:** Взаимодействие с сервисом n8n для запуска рабочих процессов генерации изображений
- **Обработка платежей:** Интеграция с платежными шлюзами

## 🛠 Технологический стек

### Основные технологии

| Технология | Версия | Назначение |
|------------|--------|------------|
| **Go** | 1.25.1 | Основной язык программирования |
| **Gin** | 1.10.1 | Веб-фреймворк для создания RESTful API |
| **PostgreSQL** | - | Основная реляционная база данных |
| **Redis** | 9.14.0 | In-memory БД для кэширования и сессий |
| **Docker** | - | Контейнеризация приложения |

### Библиотеки и зависимости

#### Работа с базами данных
- **sqlx** (1.4.0) - Расширение для database/sql с удобными методами
- **lib/pq** (1.10.9) - PostgreSQL драйвер
- **go-redis** (9.14.0) - Клиент для Redis

#### Аутентификация и безопасность
- **jwt/v5** (5.3.0) - JSON Web Tokens для аутентификации
- **uuid** (1.6.0) - Генерация уникальных идентификаторов

#### Конфигурация и логирование
- **Viper** (1.21.0) - Управление конфигурацией приложения
- **Logrus** (1.9.3) - Структурированное логирование
- **godotenv** (1.5.1) - Загрузка переменных окружения из .env файла

## 🏗 Архитектура проекта

Проект построен на принципах **Clean Architecture** с разделением на три основных слоя:

```
┌─────────────────────────────────────────┐
│         HTTP Layer (Gin)                │
│  ┌───────────────────────────────────┐  │
│  │         Handlers                  │  │
│  │  • auth.go                        │  │
│  │  • user_settings.go               │  │
│  │  • middleware.go                  │  │
│  └───────────────────────────────────┘  │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│         Business Logic Layer            │
│  ┌───────────────────────────────────┐  │
│  │         Services                  │  │
│  │  • auth.go                        │  │
│  │  • user_settings.go               │  │
│  └───────────────────────────────────┘  │
└─────────────────┬───────────────────────┘
                  │
┌─────────────────▼───────────────────────┐
│         Data Access Layer               │
│  ┌───────────────────────────────────┐  │
│  │       Repositories                │  │
│  │  • auth_postgres.go               │  │
│  │  • user_setting_postgres.go       │  │
│  │  • redis.go                       │  │
│  └───────────────────────────────────┘  │
└─────────────────┬───────────────────────┘
                  │
        ┌─────────┴─────────┐
        ▼                   ▼
  ┌──────────┐        ┌──────────┐
  │PostgreSQL│        │  Redis   │
  └──────────┘        └──────────┘
```

### Паттерны проектирования

- **Repository Pattern** - Абстракция работы с данными
- **Dependency Injection** - Внедрение зависимостей через конструкторы
- **Middleware Pattern** - Обработка запросов через цепочку middleware
- **Clean Architecture** - Разделение на независимые слои

## 📁 Структура проекта

```
Go1.25/
├── cmd/
│   └── main.go                      # Точка входа приложения
│
├── pkg/                             # Основной код приложения
│   ├── handler/                     # HTTP handlers (Gin routes)
│   │   ├── handler.go              # Инициализация роутов
│   │   ├── auth.go                 # Аутентификация (login, register)
│   │   ├── user_settings.go        # Настройки пользователя
│   │   ├── middleware.go           # JWT middleware, CORS
│   │   └── response.go             # Стандартизированные ответы
│   │
│   ├── service/                     # Бизнес-логика
│   │   ├── service.go              # Инициализация сервисов
│   │   ├── auth.go                 # Логика аутентификации
│   │   └── user_settings.go        # Логика настроек пользователя
│   │
│   └── repository/                  # Работа с базами данных
│       ├── repository.go           # Инициализация репозиториев
│       ├── postgres.go             # Подключение к PostgreSQL
│       ├── redis.go                # Подключение к Redis
│       ├── auth_postgres.go        # Репозиторий аутентификации
│       └── user_setting_postgres.go # Репозиторий настроек
│
├── configs/
│   └── config.yml                   # Конфигурация приложения
│
├── migrate/                         # Миграции базы данных
│   ├── 000001_init.up.sql          # Создание таблиц
│   └── 000001_init.down.sql        # Откат миграций
│
├── Dockerfile                       # Multi-stage Docker build
├── .env                            # Переменные окружения (не в git)
├── .gitignore
├── go.mod                          # Зависимости проекта
├── go.sum                          # Контрольные суммы зависимостей
├── server.go                       # HTTP сервер
├── user.go                         # Модель пользователя
├── errors.go                       # Кастомные ошибки
└── README.md
```

## 🗄 База данных

### Схема PostgreSQL

#### Основные таблицы

**users** - Пользователи системы
```sql
- id (SERIAL PRIMARY KEY)
- email (VARCHAR UNIQUE)
- password_hash (VARCHAR)
```

**user_refresh_tokens** - Токены обновления для разных устройств
```sql
- id (SERIAL PRIMARY KEY)
- user_id (INT FK → users)
- token (VARCHAR UNIQUE)
- expires_at (TIMESTAMPTZ)
- name_device (VARCHAR)
- device_info (VARCHAR)
```

**user_settings** - Настройки и профиль пользователя
```sql
- user_id (INT PRIMARY KEY FK → users)
- name (VARCHAR)
- icon (VARCHAR)
- coin (INT)
- date_of_registration (TIMESTAMPTZ)
- paid_subscription (BOOLEAN)
- date_of_paid_subscription (TIMESTAMPTZ)
```

#### Система кланов

**clan** - Кланы
```sql
- id (SERIAL PRIMARY KEY)
- name (VARCHAR UNIQUE)
- description (TEXT)
- other (JSONB)
```

**roles** - Системные роли (1-5, где 1 - самая высокая)
```sql
- id (SMALLINT PRIMARY KEY)
- name (VARCHAR)
```

**clan_members** - Участники кланов
```sql
- clan_id (INT FK → clan)
- user_id (INT FK → users)
- role_id (SMALLINT FK → roles)
- PRIMARY KEY (clan_id, user_id)
```

**clan_role_names** - Кастомные названия ролей для каждого клана
```sql
- clan_id (INT FK → clan)
- role_id (SMALLINT FK → roles)
- custom_name (VARCHAR)
- PRIMARY KEY (clan_id, role_id)
```

#### Игровые сущности

**cards** - Карточки персонажей
```sql
- id (SERIAL PRIMARY KEY)
- user_id (INT FK → users)
- name (VARCHAR)
- description (TEXT)
- other (JSONB)
```

**items** - Игровые предметы
```sql
- id (SERIAL PRIMARY KEY)
- name (VARCHAR)
- description (TEXT)
- HaveCard (BOOLEAN)
- other (JSONB)
```

### Redis

Используется для:
- **Кэширование** - Часто запрашиваемые данные
- **Сессии** - JWT токены и refresh tokens
- **Rate limiting** - Ограничение частоты запросов

## 🚀 Установка и запуск

### Предварительные требования

- Go 1.25.1 или выше
- PostgreSQL 14+
- Redis 7+
- Docker и Docker Compose (опционально)

### Локальная разработка

1. **Клонирование репозитория**
```bash
git clone <repository-url>
cd Go1.25
```

2. **Установка зависимостей**
```bash
go mod download
```

3. **Настройка переменных окружения**

Создайте файл `.env` в корне проекта:
```env
DB_PASSWORD=your_postgres_password
REDIS_PASSWORD=your_redis_password
JWT_SECRET=your_jwt_secret_key
```

4. **Запуск PostgreSQL и Redis**
```bash
# Используя Docker Compose (рекомендуется)
docker-compose up -d postgres redis
```

5. **Применение миграций**
```bash
# Используйте migrate CLI или выполните SQL вручную
psql -U postgres -d postgres -f migrate/000001_init.up.sql
```

6. **Запуск приложения**
```bash
go run cmd/main.go
```

Сервер запустится на `http://localhost:8080`

### Docker Deployment

Проект использует multi-stage Docker build для минимизации размера образа.

1. **Сборка образа**
```bash
docker build -t go-game-backend:latest .
```

2. **Запуск контейнера**
```bash
docker run -d \
  --name game-backend \
  -p 8080:8080 \
  --env-file .env \
  go-game-backend:latest
```

## ⚙️ Конфигурация

### config.yml

```yaml
port: "8080"              # Порт HTTP сервера

db:
  username: "postgres"    # Пользователь PostgreSQL
  host: "localhost"       # Хост PostgreSQL
  port: "5432"           # Порт PostgreSQL
  database: "postgres"    # Имя базы данных
  sslmode: "disable"     # SSL режим

redis:
  addr: "localhost:6379" # Адрес Redis
  db: 0                  # Номер базы данных Redis
```

### Переменные окружения (.env)

```env
DB_PASSWORD=          # Пароль PostgreSQL
REDIS_PASSWORD=       # Пароль Redis (если установлен)
JWT_SECRET=           # Секретный ключ для JWT
```

## 📝 Этапы разработки

### ✅ Завершено

1. **Настройка окружения** - Установка Go, настройка рабочего пространства, инициализация проекта
2. **Проектирование архитектуры** - Определение структуры проекта, модулей и схемы базы данных
3. **Реализация API для пользователей** - Разработка эндпоинтов для регистрации, авторизации и управления профилем
4. **Интеграция с базами данных** - Настройка подключения к PostgreSQL и Redis, реализация моделей и репозиториев
5. **Система кланов** - Реализация базовой структуры кланов с ролями

### 🔄 В процессе

6. **Разработка ядра игровой логики** - Создание механизмов генерации мира и персонажей, симуляция их жизни
7. **Создание API для игрового процесса** - Разработка эндпоинтов для взаимодействия с игровым миром

### 📋 Запланировано

8. **Интеграция с n8n** - Настройка взаимодействия для генерации изображений
9. **Интеграция с платежными системами** - Подключение платежных шлюзов
10. **Тестирование** - Написание unit- и интеграционных тестов для проверки корректности работы API и игровой логики
11. **Оптимизация производительности** - Профилирование и оптимизация узких мест
12. **Развертывание (Deploy)** - Подготовка к развертыванию на production сервере

---

## 📚 Дополнительная документация

- [DEVELOPMENT_PLAN.md](./DEVELOPMENT_PLAN.md) - Детальный план разработки и roadmap
- [API Documentation](./docs/API.md) - Документация API endpoints (в разработке)

## 🤝 Вклад в проект

Проект находится в активной разработке. При внесении изменений следуйте установленной архитектуре и паттернам проектирования.